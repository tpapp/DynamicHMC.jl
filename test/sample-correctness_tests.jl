include("sample-correctness_utilities.jl")

#####
##### sample correctness tests
#####
##### Sample from well-characterized distributions using LogDensityTestSuite, check
##### convergence and mixing, and compare.

"Adaptation with dense matrix"
const MCMC_ARGS2 = (warmup_stages = default_warmup_stages(; M = Symmetric),)

@testset "NUTS tests with random normal" begin
    for _ in 1:10
        K = rand(3:10)
        Œº = randn(K)
        d = abs.(randn(K))
        C = rand_C(K)
        ‚Ñì = multivariate_normal(Œº, Diagonal(d) * C)
        title = "multivariate normal Œº = $(Œº) d = $(d) C = $(C)"
        NUTS_tests(RNG, ‚Ñì, title, 1000; mcmc_args = MCMC_ARGS2)
    end
end

@testset "ill-conditioned multivariate normal" begin
    # this test case was isolated using random tests
    Œº = [-1.729922440774685, -0.011762500688978205, 0.11423091067230899, 0.05085717388622323, 0.09102774773399233, -0.3769237300508154, -1.1645971596831883, -1.4196407006756644, 0.07406060991401947]
    d = [0.31285715405356296, 1.6321047397137334, 1.9304214045496948, 0.9408515651923572, 0.632832415315841, 0.3994529605030148, 0.9479547802750243, 0.000686699019868418, 0.14074551354895906]
    C = [1.0 -0.625893845478092 -0.8607538232958145 0.4906036948283603 -0.045129301268019346 -0.9798256449980116 -0.09448716779625055 0.1972478332046149 -0.38125524332165456; 0.0 0.7799082601131022 0.22963314745353192 -0.8390321758549951 -0.2940681265758735 0.05788305453491861 -0.30348581879657555 -0.3395815944065493 0.40817023926937634; 0.0 0.0 0.45428127109998945 0.07704183020878513 0.5013749270904165 0.09940288184055725 -0.4898077520422466 -0.04390387380845317 -0.39358273046921877; 0.0 0.0 0.0 0.22225566111771966 -0.5034002085122711 0.1540822287067389 -0.52831870161212 -0.20197326086456527 -0.4230725997740589; 0.0 0.0 0.0 0.0 0.6377293278924043 0.002108173376346147 -0.563819920556515 0.07024142256309863 0.20409522211102057; 0.0 0.0 0.0 0.0 0.0 0.05444765270890811 0.21770654511030652 0.4167989822452558 0.4096707796964533; 0.0 0.0 0.0 0.0 0.0 0.0 0.12102564140379203 0.6237333486866049 -0.1142510107612157; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.4851374500990013 -0.2027266958462243; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.30084429646746724]'
    ‚Ñì = multivariate_normal(Œº, Diagonal(d) * C)
    title = "ill-conditioned multivariate normal (isolated test case 1)"
    NUTS_tests(RNG, ‚Ñì, title, 1000; mcmc_args = MCMC_ARGS2)

    d = [0.44940324099952655, 1.2470316880832284, 1.4254609657195896, 0.47414925026956667, 0.7208717869588667, 0.9012540329863461, 0.259210347514327, 0.48018821609980755, 0.036285320442367444]
    C = [1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.007468818792116497 0.999972107983943 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.9511843069109334 0.06094826193577815 0.30254540758929904 0.0 0.0 0.0 0.0 0.0 0.0; 0.5836451073483746 0.5224198876250752 -0.1567642318026896 0.6015486890596806 0.0 0.0 0.0 0.0 0.0; -0.04549583361258265 0.16604582867077644 -0.6573154635023393 0.5230837360874556 0.5144693366823966 0.0 0.0 0.0 0.0; 0.3090114014598978 0.21784144366429148 0.09455066936309542 0.7472520532986878 0.3661721405808872 0.39452447632098014 0.0 0.0 0.0; 0.27849576428755396 0.008203485989481384 -0.6289527864239539 0.5299626182310367 -0.18989119185086065 0.3458859908657774 0.30039148523055575 0.0 0.0; -0.7595504281026706 -0.6109486667620377 0.08322674440383553 -0.12441158714041263 -0.15879164203513468 -0.0032350588677425886 0.027740844099589795 0.03775094878848311 0.0; 0.8843786481850745 0.4137017432529274 0.19839646818921372 -0.07842556868606812 0.03458430271168502 0.0036393230648423818 0.0006870732712296159 -0.0015642900624311437 0.0011437266452138846]
    ‚Ñì = multivariate_normal(Œº, Diagonal(d) * C)
    title = "ill-conditioned multivariate normal (isolated test case 2)"
    NUTS_tests(RNG, ‚Ñì, title, 1000; mcmc_args = MCMC_ARGS2)

    Œº = [0.21062974278940136, -1.218937450424899, 0.06421875640449011, -0.8234583898758592, -2.31397504655407, -0.4751175796619936, -1.2623323961397874, 0.2150945580900463, 1.0797988499707567, 0.6923991470384713]
    d = [1.235510286986013, 0.25725289997297635, 0.39737933906879164, 1.2464348820193416, 0.3082850398698708, 0.9563709407505254, 1.6547932918031834, 1.9782388109071316, 0.38580150239677885, 0.45488559976648274]
    C = [1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.5858606519975413 0.8104118067013929 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; -0.3184163160259112 0.8041538301838452 0.501943888387077 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.3173460682399272 0.6771172525630316 -0.41159671670836784 0.520952821327462 0.0 0.0 0.0 0.0 0.0 0.0; -0.987376065017123 -0.0893955251935478 -0.1251983682331955 0.015871075518314355 0.03421145802664587 0.0 0.0 0.0 0.0 0.0; 0.37469357703269496 -0.8443427667670257 0.32370544135718116 -0.052396077029688945 -0.14292183643709977 0.13686782878290468 0.0 0.0 0.0 0.0; -0.6171193584146126 -0.6578898907477293 -0.39307408945037237 -0.1518878423897761 -0.04583110799414341 0.024372352823947997 0.0779290101096559 0.0 0.0 0.0; 0.5435692867326045 -0.6050903050824995 0.08910494475273394 -0.3209596162864902 0.39975938033524144 0.07516818530300905 -0.06448639900775556 0.24047260310743332 0.0 0.0; -0.06388905564192496 0.9843759627707926 -0.12367139895609519 -0.02886519073736079 0.08699952332803386 -0.020427021493780943 0.0227516163109634 0.010263085877575476 0.04674602752418515 0.0; -0.05914353971342278 0.5051281727293001 -0.0853459337837312 0.7320866937322082 0.42886052044809864 0.011574865047660135 0.10703394808902246 0.045502786672532804 -0.01539436089666275 0.017135804222740844]
    ‚Ñì = multivariate_normal(Œº, Diagonal(d) * C)
    title = "ill-conditioned multivariate normal (isolated test case 2)"
    NUTS_tests(RNG, ‚Ñì, title, 1000; mcmc_args = MCMC_ARGS2)
end

@testset "NUTS tests with specific normal distributions" begin
    ‚Ñì = multivariate_normal([0.0], 5e8)
    NUTS_tests(RNG, ‚Ñì, "univariate huge variance", 1000)

    ‚Ñì = multivariate_normal([1.0], 5e8)
    NUTS_tests(RNG, ‚Ñì, "univariate huge variance, offset", 1000)

    ‚Ñì = multivariate_normal([1.0], 5e-8)
    NUTS_tests(RNG, ‚Ñì, "univariate tiny variance, offset", 1000)

    ‚Ñì = multivariate_normal([1.0, 2.0, 3.0], Diagonal([1.0, 2.0, 3.0]))
    NUTS_tests(RNG, ‚Ñì, "mildly scaled diagonal", 1000)

    # these tests are kept because they did produce errors for some code that turned out to
    # be buggy in the early development version; this does not meant that they are
    # particularly powerful or sensitive ones
    ‚Ñì = multivariate_normal([-0.37833073009094703, -0.3973395239297558],
                            cholesky([0.08108928067723374 -0.19742780267879112;
                                      -0.19742780267879112 1.2886298811010262]).L)
    NUTS_tests(RNG, ‚Ñì, "kept 2 dim", 1000)

    ‚Ñì = multivariate_normal(
        [-1.0960316317778482, -0.2779143641884689, -0.4566289703243874],
        cholesky([2.2367476976202463 1.4710084974801891 2.41285525745893;
                  1.4710084974801891 1.1684361535929932 0.9632367554302268;
                  2.41285525745893 0.9632367554302268 4.5595606374865785]).L)
    NUTS_tests(RNG, ‚Ñì, "kept 3 dim", 1000)

    ‚Ñì = multivariate_normal(
        [-1.42646, 0.94423, 0.852379, -1.12906, 0.0868619, 0.948781, -0.875067, 1.07243],
        cholesky([14.8357 2.42526 -2.97011 2.08363 -1.67358 4.02846 5.57947 7.28634;
                   2.42526 10.8874 -1.08992 1.99358 1.85011 -2.29754 -0.0540131 1.79718;
                   -2.97011 -1.08992 3.05794 0.0321187 1.8052 -1.5309 1.78163 -0.0821483;
                   2.08363 1.99358 0.0321187 2.38112 -0.252784 0.666474 1.73862 2.55874;
                   -1.67358 1.85011 1.8052 -0.252784 12.3109 -2.3913 -2.99741 -1.95031;
                   4.02846 -2.29754 -1.5309 0.666474 -2.3913 4.89957 3.6118 5.22626;
                   5.57947 -0.0540131 1.78163 1.73862 -2.99741 3.6118 10.215 9.60671;
                   7.28634 1.79718 -0.0821483 2.55874 -1.95031 5.22626 9.60671 11.5554]).L)
    NUTS_tests(RNG, ‚Ñì, "kept 8 dim", 1000)
end

@testset "NUTS tests with mixtures" begin
    ‚Ñì1 = multivariate_normal(zeros(3), 1.0)
    D2 = I * 0.4
    C2 = [1.0 -0.48058358598852935 0.39971148270854306;
          0.0 0.876948924897229 -0.5361348433365906;
          0.0 0.0 0.7434985947205197]
    ‚Ñì2 = multivariate_normal(ones(3), D2 * C2)
    ‚Ñì = mix(0.2, ‚Ñì1, ‚Ñì2)
    NUTS_tests(RNG, ‚Ñì, "mixture of two normals", 1000; œÑ_alert = 0.15)
end

@testset "NUTS tests with heavier tails and skewness" begin
    K = 5

    # somewhat nasty, relaxed requirements
    ‚Ñì = elongate(1.1, StandardMultivariateNormal(K))
    NUTS_tests(RNG, ‚Ñì, "elongate(1.1, ùëÅ)", 1000; p_alert = 1e-5, EBFMI_alert = 0.2, RÃÇ_fail = 1.25)

    # this has very nasty tails so we relax requirements a bit
    ‚Ñì = elongate(1.1, shift(ones(K), StandardMultivariateNormal(K)))
    NUTS_tests(RNG, ‚Ñì, "skew elongate(1.1, ùëÅ)", 10000; œÑ_alert = 0.1, EBFMI_alert = 0.2)
end
